{% extends "base.html" %}

{% block content %}
<div class="dashboard-container">
    <header class="flex justify-between items-center mb-12">
        <div>
            <div class="flex items-center gap-3">
                <h1 class="text-4xl">Dashboard</h1>
                {% if engine_paused %}
                <span
                    class="px-2 py-1 rounded bg-amber-500/10 text-amber-500 text-[10px] font-bold uppercase tracking-wider border border-amber-500/20">Paused</span>
                {% else %}
                <span
                    class="px-2 py-1 rounded bg-emerald-500/10 text-emerald-500 text-[10px] font-bold uppercase tracking-wider border border-emerald-500/20">Running</span>
                {% endif %}
            </div>
            <p class="text-slate-400 mt-1">Next-Gen Transcoding Engine</p>
        </div>
        <div class="flex gap-4">
            {% include "partials/engine_control.html" %}
            <button hx-post="/api/jobs/restart-failed" hx-swap="none"
                class="btn border border-slate-800 text-slate-400 hover:text-slate-200">
                Restart Failed
            </button>
            <button hx-post="/api/jobs/clear-completed" hx-swap="none"
                class="btn border border-slate-800 text-slate-400 hover:text-slate-200">
                Clear Completed
            </button>
            <button hx-post="/api/scan" hx-swap="none" class="btn btn-primary">
                Scan Now
            </button>
        </div>
    </header>

    <div class="grid-stats" id="stats-container" hx-get="/api/stats" hx-trigger="every 5s">
        {% include "partials/stats.html" %}
    </div>

    <div class="glass-card mb-8" style="padding: 0; overflow: hidden;">
        <div class="px-8 py-5 border-b border-slate-800 flex justify-between items-center">
            <h2 class="text-xl">Engine Activity</h2>
            <span class="text-xs font-medium text-slate-500 bg-slate-800 px-3 py-1 rounded-full">v0.1.0</span>
        </div>
        <div class="overflow-x-auto" id="jobs-table-container" hx-ext="sse" sse-connect="/api/events"
            sse-swap="status, progress" hx-get="/api/jobs/table" hx-trigger="every 5s, sse:status">
            {% include "partials/jobs_table.html" %}
        </div>
    </div>

    <div class="glass-card overflow-hidden">
        <div class="px-8 py-5 border-b border-slate-800">
            <h2 class="text-xl">System Logs</h2>
        </div>
        <div id="console" class="p-6 font-mono text-xs overflow-y-auto max-h-64 space-y-1 bg-black/30" hx-ext="sse"
            sse-connect="/api/events" sse-swap="log" hx-swap="beforeend">
        </div>
    </div>
</div>

<script>
    document.body.addEventListener('htmx:sseMessage', function (e) {
        if (e.detail.type === 'log') {
            const console = document.getElementById('console');
            const line = document.createElement('div');
            line.className = 'text-slate-400 border-l-2 border-slate-800 pl-3 py-0.5';
            line.textContent = `[${new Date().toLocaleTimeString()}] ${e.detail.data}`;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
            if (console.children.length > 100) console.removeChild(console.firstChild);
        } else if (e.detail.type === 'progress') {
            const data = JSON.parse(e.detail.data);
            const bar = document.querySelector(`#job-progress-${data.job_id}`);
            const text = document.querySelector(`#job-progress-text-${data.job_id}`);
            if (bar) bar.style.width = data.percentage + '%';
            if (text) text.textContent = data.percentage + '%';
        }
    });
</script>
{% endblock %}